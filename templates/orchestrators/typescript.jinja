{# TypeScript orchestrator template #}
{%- if module %}
/**
 * Module: {{ module }}
 */

{% endif -%}
{%- if provenance %}
// GENERATED FROM: {{ id }}.yaml
// GENERATED: {{ generated_at }}
// DO NOT EDIT - regenerate from spec

{% endif -%}
export interface {{ id_pascal }}Input {
{%- for input in inputs %}
    {{ input.name_camel }}: {{ input.ts_type }};
{%- endfor %}
}

export interface {{ id_pascal }}Output {
{%- for output in outputs %}
    {{ output.name_camel }}: {{ output.ts_type }};
{%- endfor %}
}

interface {{ id_pascal }}Context {
{%- for step in steps %}
{%- if step.is_call %}
    {{ step.id }}?: unknown;
{%- endif %}
{%- endfor %}
}

export class {{ id_pascal }}Error extends Error {
    constructor(
        public readonly step: string,
        public readonly type: "step_failed" | "gate_failed" | "timeout",
        message: string
    ) {
        super(message);
        this.name = "{{ id_pascal }}Error";
    }
}

export async function {{ id_camel }}(input: {{ id_pascal }}Input): Promise<{{ id_pascal }}Output> {
    const ctx: {{ id_pascal }}Context = {};
{%- for step in steps %}
{%- if step.is_call %}
{%- if step.condition_ts %}

    // Step: {{ step.id }} (call {{ step.spec_id }}) - conditional
    if ({{ step.condition_ts }}) {
{%- endif %}
    // Step: {{ step.id }} (call {{ step.spec_id }})
    const {{ step.id }}_result = await {{ step.spec_id }}({
{%- for mapping in step.input_mappings %}
        {{ mapping.spec_input_name | camel_case }}: {{ mapping.expr_ts }}{% if not loop.last %},{% endif %}
{%- endfor %}
    });
    ctx.{{ step.id }} = {{ step.id }}_result;
{%- if step.condition_ts %}
    }
{%- endif %}
{%- elif step.is_gate %}

    // Gate: {{ step.id }}
    if (!({{ step.condition_ts }})) {
        throw new {{ id_pascal }}Error(
            "{{ step.id }}",
            "gate_failed",
            "Gate condition failed: {{ step.condition }}"
        );
    }
{%- elif step.is_compute %}

    // Compute: {{ step.id }}
    // TODO: Implement compute step
{%- elif step.is_branch %}

    // Branch: {{ step.id }}
    if ({{ step.condition_ts }}) {
        // TODO: true branch
    } else {
        // TODO: false branch
    }
{%- elif step.is_loop %}

    // Loop: {{ step.id }}
    // TODO: Implement loop
{%- endif %}
{%- endfor %}

    return {
{%- for output in outputs %}
        {{ output.name_camel }}: undefined as any, // TODO: map output from context
{%- endfor %}
    };
}
